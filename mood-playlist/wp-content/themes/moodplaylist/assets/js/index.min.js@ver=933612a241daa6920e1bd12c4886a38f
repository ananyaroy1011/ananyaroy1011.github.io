const $=window.jQuery,spotifyApi="https://api.spotify.com/v1/";let spotifyUser=!1,artists=!1,tracks=!1,seeds=[],numSelected=0,hasClicked=!1,refPlaylist=!1,scrollTop=0,valence=!1,energy=!1,playlistID=!1,postID=sessionStorage.getItem("postID")||!1,ref=$("body").data("ref")||sessionStorage.getItem("ref")||"",colourscheme=!1,campaignData=!1,aeSeedArtists=[],aeSeedTracks=[];jQuery(document).ready((function(e){document.body.classList.remove("no-js"),window.$=e,setTimeout((()=>{window.scrollTo(0,1)}),0),e("body").removeClass("loading").addClass("splash"),refPlaylist=!!e("body").data("ref")&&e("body").data("ref");!!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/)&&e("body").addClass("safari"),isMobile.any&&e("body").addClass("mobile"),campaignData=getCampaignData(),intro(window,document,window.jQuery)}));class Err{constructor(e){this.message=e}}Err.prototype=new Error;const handleError=(e,t=!0,a=!1)=>{if(t&&(a=!0),a){let a=t?e:"Sorry, something went wrong. Please refresh the page and try again.";$("#error .info").text(a),$("#error").slideDown(300,(function(){setTimeout((()=>{$("#error").slideUp()}),3500)}))}},getCampaignData=()=>{let e={};return-1!=location.search.indexOf("utm_source")&&(e.utm_source=location.search.split("utm_source")[1].split("&")[0].split("=")[1]),-1!=location.search.indexOf("utm_medium")&&(e.utm_medium=location.search.split("utm_medium")[1].split("&")[0].split("=")[1]),-1!=location.search.indexOf("utm_campaign")&&(e.utm_campaign=location.search.split("utm_campaign")[1].split("&")[0].split("=")[1]),-1!=location.search.indexOf("utm_content")&&(e.utm_content=location.search.split("utm_content")[1].split("&")[0].split("=")[1]),-1!=location.search.indexOf("utm_term")&&(e.utm_term=location.search.split("utm_term")[1].split("&")[0].split("=")[1]),Object.keys(e).length>0&&e},changeSection=(e,t)=>{TweenMax.fromTo(`#${e}`,1,{"-webkit-filter":"blur(0)",filter:"blur(0)",alpha:1},{"-webkit-filter":"blur(20px)",filter:"blur(20px)",alpha:0,onComplete:function(){$(`#${e}`).hide(),$(`#${t}`).show(),TweenMax.fromTo(`#${t}`,1,{"-webkit-filter":"blur(20px)",filter:"blur(20px)",alpha:0},{"-webkit-filter":"blur(0)",filter:"blur(0)",alpha:1})}})},furthestFrom=(e,t)=>t.x==t.y?t.x:(x1=Math.abs(t.x-e),y1=Math.abs(t.y-e),x1<y1?t.y:(y1,x1,t.x)),hideLoader=e=>{-1!=$(`#${e}`).attr("style").indexOf("blur(0px)")&&$(`#${e}`).attr("style",$(`#${e}`).attr("style").replace("blur(0px)","")),TweenMax.fromTo(`#${e} .loading`,1,{"-webkit-filter":"blur(0)",filter:"blur(0)",alpha:1},{"-webkit-filter":"blur(20px)",filter:"blur(20px)",alpha:0,onComplete:function(){$(`#${e} .loading`).hide(),$(`#${e} .wrap`).show(),TweenMax.fromTo(`#${e} .wrap`,1,{"-webkit-filter":"blur(20px)",filter:"blur(20px)",alpha:0},{"-webkit-filter":"blur(0)",filter:"blur(0)",alpha:1})}})},doModal=e=>{e?($("body").addClass("modal-open"),$(".modal-bg").animate({top:0},1e3,(function(){$(e).fadeIn(1e3)}))):($("body").removeClass("modal-open"),$(".modal-content").fadeOut(1e3),setTimeout((()=>{$(".modal-bg").animate({top:0-(window.innerHeight+8*parseFloat(getComputedStyle(document.documentElement).fontSize))},1e3),$("body").hasClass("subscribe-modal")&&$("body").removeClass("colours-0 subscribe-modal")}),1e3))};$(".modal-bg").click((function(){doModal()}));const sendToSMF=async()=>{try{const e=document.getElementById("terms").checked,t={field_email_address:$("#user_email").val(),form:"59493",default_mailing_list:e?"a0S1p00000QzDOeEAN":"",ae:"053de84e36c3606d88ef6ba8548d6b5cb47c6df6953b4240a75f67aec45ca77b",ae_member_id:aeJS.user.data.ID,ae_segment_id:"979167",ae_brand_id:"3453486",ae_activities:e?'{"mailing_list_optins":{"a0S1p00000QzDOeEAN":34335}}':'{"actions":{"presave":34332}}',"custom_field[Custom_Field_1]":playlistID||""},a={method:"POST",credentials:"omit",mode:"cors",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t).toString()},s=await fetch("https://subs.sonymusicfans.com/submit",a);return await s.json()}catch(e){handleError(e,!1,!1)}},updateShareButtons=()=>{const e=$($("meta[name=description]")[1]).attr("content");let t=`${location.origin}${postID?`/share?pid=${postID}`:""}`,a=`https://www.facebook.com/dialog/share?app_id=632073770326097&display=popup&quote=${encodeURIComponent(e)}&href=${encodeURIComponent(t)}`;$("#fbShare").attr("href",a);let s=`https://twitter.com/intent/tweet?text=${encodeURIComponent(`${e} - ${t}`)}`;$("#twShare").attr("href",s)},intro=(e,t,a,s)=>{-1!=location.search.indexOf("accessToken")&&-1!=location.search.indexOf("ae_session")&&"string"==typeof sessionStorage.valence&&"string"==typeof sessionStorage.energy&&"string"==typeof sessionStorage.bodyclass&&onSpotifyLogin();a("#arrow").click((()=>{a("body").hasClass("fixed")||(e.scrollTo(0,1),a("html, body").animate({scrollTop:t.body.scrollHeight},2*e.innerHeight))})),a("#submitMood").click((function(){sessionStorage.setItem("valence",valence),sessionStorage.setItem("energy",energy),sessionStorage.setItem("bodyclass",a("body").attr("class")),sessionStorage.setItem("ref",ref),sessionStorage.setItem("colourscheme",colourscheme),localStorage.setItem("campaignData",JSON.stringify(campaignData)),changeSection("splash","login"),TweenMax.to(["footer"],1,{"-webkit-filter":"blur(0)",filter:"blur(0)",alpha:1})})),(()=>{let t=new TimelineMax;TweenMax.staggerTo([".screen.first .__fade-in-blur","#arrow","footer"],1,{"-webkit-filter":"blur(0)",filter:"blur(0)",alpha:1},.25,(()=>{const e=TweenMax.to("#arrow",1,{y:50,ease:Power2.easeInOut,repeat:-1,yoyo:!0});t.add(e).play()}));const s=new ScrollMagic.Controller,r=new TimelineMax;r.to("#arrow",1,{rotation:"150"}),r.to([".screen.first .__fade-in-blur","footer"],1,{"-webkit-filter":"blur(20px)",filter:"blur(20px)",alpha:0});const o=1.5*e.innerHeight-(e.innerHeight-2*a("#arrow").height());let n=isMobile.any?0-a("#arrow").height():a("#arrow").height()/2;const i=new ScrollMagic.Scene({triggerElement:"#arrow",duration:o,offset:n});i.setPin("#arrow",{pushFollowers:!1,spacerClass:"arrow-wrap"}),i.setTween(r),i.on("start",(e=>{t.pause().to("#arrow",0,{y:0}),TweenMax.to("footer",1,{"-webkit-filter":"blur(20px)",filter:"blur(20px)",alpha:0})})),i.addTo(s);const l=e.innerHeight/2,c=TweenMax.staggerTo([".screen.second .__fade-in-blur","#arrow"],1,{"-webkit-filter":"blur(0)",filter:"blur(0)",alpha:1},.25),d=new ScrollMagic.Scene({triggerElement:".screen.second",duration:l});d.setTween(c),d.addTo(s),d.on("start",(e=>{t.pause().to("#arrow",0,{y:0})})),d.on("end",(()=>{s.destroy(!1),a("body").removeClass("splash"),a(".screen.first").hide(),a("#arrow").appendTo(".screen.second");let t={x:50,y:50};Draggable.create("#arrow",{type:"x,y",edgeResistance:.65,bounds:".screen.second",inertia:!0,onDrag:function(){t.x=Number(Number(this.pointerX)/Number(e.innerWidth)*100),t.y=Number(100-Number(this.pointerY)/Number(e.innerHeight)*100);var s,r;(s=50,(r=t).x==r.y?r.x:(x1=Math.abs(r.x-s),y1=Math.abs(r.y-s),x1<y1?r.y:(y1,x1,r.x)))==t.x?t.x<50?(a("body").removeClass("colours-1 colours-2 colours-4").addClass("colours-3"),colourscheme=3):(a("body").removeClass("colours-1 colours-2 colours-3").addClass("colours-4"),colourscheme=4):t.y<50?(a("body").removeClass("colours-1 colours-3 colours-4").addClass("colours-2"),colourscheme=2):(a("body").removeClass("colours-2 colours-3 colours-4").addClass("colours-1"),colourscheme=1),a(".screen.second .instructions").hasClass("faded")||TweenMax.to(".screen.second .instructions",1,{"-webkit-filter":"blur(20px)",filter:"blur(20px)",alpha:0,onComplete:function(){a(".screen.second .instructions").addClass("faded").css("pointer-events","none")}}),a("#submitMood").hasClass("visible")||(a("#submitMood").show(),TweenMax.to("#submitMood",1,{"-webkit-filter":"blur(0)",filter:"blur(0)",alpha:1,onComplete:function(){a("#submitMood").addClass("visible").css("pointer-events","all")}})),valence=Number((t.y/100).toFixed(2)>1?1:(t.y/100).toFixed(2)<0?0:(t.y/100).toFixed(2)),energy=Number((t.x/100).toFixed(2)>1?1:(t.x/100).toFixed(2)<0?0:(t.x/100).toFixed(2)),valence<0?valence=0:valence>100&&(valence=100),energy<0?energy=0:energy>100&&(energy=100),Number(e.innerWidth)<=992?(a(".moods .text.--top").css("font-size",4*valence<2?"10px":4*valence+"vmin"),a(".moods .text.--bottom").css("font-size",4-4*valence<2?"10px":4-4*valence+"vmin"),a(".moods .text.--left").css("font-size",4-4*energy<2?"10px":4-4*energy+"vmin"),a(".moods .text.--right").css("font-size",4*energy<2?"10px":4*energy+"vmin")):(a(".moods .text.--top").css("font-size",4*valence<1.5?"16px":4*valence+"vmin"),a(".moods .text.--bottom").css("font-size",4-4*valence<1.5?"16px":4-4*valence+"vmin"),a(".moods .text.--left").css("font-size",4-4*energy<1.5?"16px":4-4*energy+"vmin"),a(".moods .text.--right").css("font-size",4*energy<1.5?"16px":4*energy+"vmin"))}}),a("#arrow").removeAttr("style").addClass("is-draggable")}))})()},getSeeds=async e=>{try{const t={action:"smemp_spotify_get_seeds",data:new URLSearchParams({token:spotifyUser.Token,type:e}).toString()},a={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"},credentials:"same-origin",body:new URLSearchParams(t).toString()},s=await fetch(smemp_ajax.ajaxurl,a);return await s.json()}catch(e){handleError(!1,!1,!0)}},handleTrackSeeds=async(e,t)=>{let a=[];for(let s=t;s>0;s--)a.push(e[s]);return a},appendSeed=async e=>{const t=e.hasOwnProperty("album")?e.album.images:e.images;$("#seeds .wrap .seeds-wrap").append(`\n    <div class="seed" data-id="${e.id}">\n    ${t.length?`<div class="seed-image">\n        <img src="${t[0].url}" alt="${e.name} on Spotify" />\n      </div>`:""}\n      <div class="seed-content">\n        <h4>${e.name}</h4>\n      </div>\n    </div>\n  `)};$("body").on("click",".seed",(function(){$(this).hasClass("selected")?($(this).removeClass("selected"),numSelected--):numSelected<5&&($(this).addClass("selected"),numSelected++),5==numSelected?$("#seedsSubmit").removeClass("is-disabled").text("Create playlist"):$("#seedsSubmit").addClass("is-disabled").text("Select 5 artists")})),$("#seedsSubmit").click((function(){if(!$(this).hasClass("is-disabled")){let e=[];if($(".seed").each((function(){$(this).hasClass("selected")&&e.push($(this).attr("data-id"))})),5!=e.length)return void handleError("Please select five artists.");changeSection("seeds","result"),$("#seedsSubmit").fadeOut(),results(e),sessionStorage.clear()}})),$("#spotifyLoginButton").on("click",(()=>{hasClicked=!0}));const handleAeOptins=async()=>{try{const e=await aeJS.user.optins.filter((e=>"Brand"==e.Type||"Artist"==e.Type));if(!e.length)return;const t={action:"smemp_ae_handle_optins",data:new URLSearchParams({optins:await e.map((e=>e.ID)).join(",")}).toString()},a={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"},credentials:"same-origin",body:new URLSearchParams(t).toString()},s=await fetch(smemp_ajax.ajaxurl,a),r=await s.json();aeSeedArtists=r,await aeSeedArtists.forEach((async e=>{const t=await getRecommendations(e.join(","));aeSeedTracks=aeSeedTracks.concat(t)}))}catch(e){handleError("Error handling AE optins.",!1)}},onSpotifyLogin=async()=>{handleAeOptins(),$("#user_email").val(aeJS.user.data.Email),sessionStorage.length&&($("body").attr("class",sessionStorage.getItem("bodyclass")),$("#splash").hide(),hasClicked=!0,valence=Number(sessionStorage.getItem("valence")),energy=Number(sessionStorage.getItem("energy")),colourscheme=sessionStorage.getItem("colourscheme"),postID=sessionStorage.getItem("postID")||!1,campaignData=JSON.parse(sessionStorage.getItem("campaignData"))||getCampaignData());try{if(spotifyUser=await aeJS.user.services.find((e=>"spotify"===e.Service)),!hasClicked)return;if(spotifyUser&&void 0!==spotifyUser){if("0"==spotifyUser.PaidAccount)return handleError("You must login with a Spotify Premium account."),!1;{changeSection("login","seeds"),$("#seedsSubmit").fadeIn();let e=[];seeds=await getSeeds("artists"),Object.keys(seeds).forEach((t=>{e.push(seeds[t])})),seeds=e;let t=[];if(tracks=await getSeeds("tracks"),Object.keys(tracks).forEach((e=>{t.push(tracks[e])})),tracks=t,artists.length+tracks.length<12)return handleError("Sorry, there was not enough listening data in your Spotify account to create your playlist."),!1;let a=12-artists.length;if(a>0){if(!(tracks.length>a))return handleError("Sorry, there was not enough listening data in your Spotify account to create your playlist."),!1;{$("#seeds .loading p").text("BRB, fetching your favourite songs..."),$("#seeds .instructions p").text("Select 5 artists and tracks to match your MOOD");const e=handleTrackSeeds(tracks,a);seeds=seeds.concat(e)}}await seeds.forEach(appendSeed),hideLoader("seeds")}}else handleError("Error connecting to Spotify. Please reload the page and try again.")}catch(e){handleError(e,!1,!1)}},getRecommendations=async e=>{try{const t={action:"smemp_spotify_get_recs",data:new URLSearchParams({token:spotifyUser.Token,seeds:e,valence:valence,energy:energy,country:aeJS.user.data.CountryCode}).toString()},a={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"},credentials:"same-origin",body:new URLSearchParams(t).toString()},s=await fetch(smemp_ajax.ajaxurl,a);return await s.json()}catch(e){handleError(e,!1,!1),handleError(!1,!1,!0)}},getArtistsData=async e=>{try{const t={action:"smemp_spotify_get_artists_data",data:new URLSearchParams({token:spotifyUser.Token,artists:await e.map((e=>e.id)).join(",")}).toString()},a={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"},credentials:"same-origin",body:new URLSearchParams(t).toString()},s=await fetch(smemp_ajax.ajaxurl,a);return await s.json()}catch(e){handleError(e,!1,!1),handleError(!1,!1,!0)}},filterTracksByGenre=async(e,t)=>{try{const a={action:"smemp_spotify_filter_tracks_by_genre",data:new URLSearchParams({token:spotifyUser.Token,tracks:e,genres:t}).toString()},s={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"},credentials:"same-origin",body:new URLSearchParams(a).toString()},r=await fetch(smemp_ajax.ajaxurl,s);return await r.json()}catch(e){handleError(e,!1,!1),handleError(!1,!1,!0)}},filterTracksByValues=async e=>{try{e.length=Math.min(e.length,100);const t={action:"smemp_spotify_get_audio_features",data:new URLSearchParams({token:spotifyUser.Token,ids:e,valence:valence,energy:energy}).toString()},a={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"},credentials:"same-origin",body:new URLSearchParams(t).toString()},s=await fetch(smemp_ajax.ajaxurl,a);return await s.json()}catch(e){handleError(e,!1,!1)}},filterMoreTracksByValues=async e=>{try{e.length=Math.min(e.length,100);const t={action:"smemp_spotify_get_more_seed_tracks",data:new URLSearchParams({token:spotifyUser.Token,ids:e,valence:valence,energy:energy}).toString()},a={method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Cache-Control":"no-cache"},credentials:"same-origin",body:new URLSearchParams(t).toString()},s=await fetch(smemp_ajax.ajaxurl,a);return await s.json()}catch(e){handleError(e,!1,!1)}},createPlaylist=async e=>{try{let t=(100*valence).toFixed(0);const a=(100*energy).toFixed(0),s=e.map((e=>e.name)).join(", ");let r=valence>=.5?"Upbeat":"Downbeat";r+=" & ",r+=energy>=.5?"Energetic":"Mellow";let o="Created at moodplayl.ist with settings: ";o+=`${t}% upbeat, ${a}% energetic, `,o+=`artists: ${s}.`;const n={method:"POST",headers:{Authorization:"Bearer "+spotifyUser.Token,"Content-Type":"application/json"},body:JSON.stringify({name:`MOOD Playlist (${r})`,description:o})},i=await fetch(`${spotifyApi}users/${spotifyUser.UserID}/playlists`,n);return await i.json()}catch(e){handleError(e,!1,!1),handleError(!1,!1,!0)}},removeArtistDupes=async e=>{let t={};return e.filter((e=>{let a=!0;return e.artists.map((e=>{t.hasOwnProperty(e.id)?t[e.id]++:t[e.id]=1,t[e.id]>=5&&(a=!1)})),a}))},addTracks=async(e,t)=>{try{const a={method:"POST",headers:{Authorization:"Bearer "+spotifyUser.Token,"Content-Type":"application/json"},body:JSON.stringify({uris:t.map((e=>e.uri))})},s=await fetch(`${spotifyApi}playlists/${e}/tracks`,a);return await s.json()}catch(e){handleError(e,!1,!1),handleError(!1,!1,!0)}},embedPlaylist=async e=>{$("#result .playlist-embed").append(`\n    <iframe \n      src="https://open.spotify.com/embed/playlist/${e}" \n      frameborder="0" \n      allowtransparency="true" \n      allow="encrypted-media"\n    ></iframe>`),setTimeout((()=>{$("#result .playlist-embed iframe").attr("src",$("#result .playlist-embed iframe").attr("src"))}),5e3)},createWpPost=e=>{try{const t={action:"smemp_create_post",data:e};$.post(smemp_ajax.ajaxurl,t).done((e=>{e&&e.hasOwnProperty("post")&&(postID=`${e.post}`)}))}catch(e){handleError(e,!1,!1)}},results=async e=>{let t=seeds.filter((t=>e.includes(t.id)));const a=await getArtistsData(t);let s=[];a.artists.forEach((e=>{e.genres.forEach((e=>{s.push(e.replace(/\s+/g,"-"))}))}));let r=await getRecommendations(e.join(","));if(aeSeedTracks.length){const e=await filterTracksByGenre(aeSeedTracks.tracks,s);r=r.tracks.concat(e)}else r=r.tracks;let o=await filterTracksByValues(r.map((e=>e.id)).join(","));const n=await o.map((e=>e.id));o=await r.filter((e=>n.includes(e.id))),tracks.length=Math.min(tracks.length,100);let i=await filterTracksByValues(tracks.map((e=>e.id)).join(","));const l=await i.map((e=>e.id));i=await tracks.filter((e=>l.includes(e.id))),i=await filterTracksByGenre(i,s),i.length>o.length&&(i.length=Math.max(o.length,Math.min(16,i.length)));let c=o.concat(i);if(c=c.sort((()=>Math.random()-.5)),c=[...new Set(c.map(JSON.stringify))].map(JSON.parse),c.length<=12){let e=await filterMoreTracksByValues(tracks.map((e=>e.id)).join(","));const t=await e.map((e=>e.id));e=await tracks.filter((e=>t.includes(e.id))),c=c.concat(e)}if(c.length<=16){let e=await filterMoreTracksByValues(r.map((e=>e.id)).join(","));const t=await e.map((e=>e.id));e=await r.filter((e=>t.includes(e.id))),c=c.concat(e)}c=[...new Set(c.map(JSON.stringify))].map(JSON.parse);const d=await removeArtistDupes(c),m=seeds.filter((t=>e.includes(t.id))),p=await createPlaylist(m);playlistID=p.id;if((await addTracks(playlistID,d)).hasOwnProperty("snapshot_id")){await embedPlaylist(p.id),$("#uriButton").attr("href",p.uri),hideLoader("result"),sendToSMF();let e={playlist_id:playlistID,user:aeJS.user.data.ID,ref:ref,valence:100*valence,energy:100*energy,colour:colourscheme,seeds:JSON.stringify(m.map((e=>({name:e.name,id:e.id,uri:e.uri})))),tracks:JSON.stringify(d.map((e=>({name:e.name,id:e.id,uri:e.uri,artists:e.artists}))))};0!=campaignData&&await Object.keys(campaignData).forEach((t=>{e[t]=campaignData[t]})),createWpPost(e)}else handleError("Error adding tracks to Spotify playlist")};$("#share").click((e=>{if(e.preventDefault(),updateShareButtons(),void 0===navigator.share)doModal("#shareButtons");else{const e={title:"MOOD Playlist",text:$($("meta[name=description]")[1]).attr("content"),url:`${location.origin}${postID?`/share?pid=${postID}`:""}`};navigator.share(e)}})),$("#shareButtons a").click((()=>{doModal("exit")})),$("#another").click((e=>{e.preventDefault(),sessionStorage.clear(),window.scrollTo(0,1),window.location.href=window.location.origin})),$("#signupButton").click((()=>{$("body").addClass("colours-0 subscribe-modal"),doModal("#signup")})),$("#signupform").submit((async e=>{if(e.preventDefault(),!document.getElementById("terms").checked)return!1;let t="Sorry, an error occurred. Please try again later.";return"thank-you"==(await sendToSMF()).state&&(t="Thank you. You have successfully signed up to the Soundcheck newsletter."),$(".subscribe__result p").text(t),TweenMax.to(".subscribe__result",1,{"-webkit-filter":"blur(0)",filter:"blur(0)",alpha:1,display:"block"}),!0})),$(".hamburger-wrap").click((e=>{e.preventDefault();const t=Boolean($(e.currentTarget).attr("aria-expanded"));$(e.currentTarget).toggleClass("active").attr("aria-expanded",!t.toString()),$("nav.main-nav").toggleClass("active")})),window.AEJSReady=e=>{window.aeJS=e,e.settings.auth_window=!0,e.settings.scopes={spotify:"user-read-email, user-read-private, user-read-recently-played, user-top-read, user-library-modify, playlist-modify-public"},e.events.onLogin.addHandler(onSpotifyLogin)};